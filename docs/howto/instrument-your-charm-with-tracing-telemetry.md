(how-to-instrument-your-charm-with-tracing-telemetry)=
# How to instrument your charm with tracing telemetry

```{note}

This howto has been incorporated into [the Tempo charm docs](https://charmhub.io/topics/charmed-tempo-ha/instrument%20your%20charm).

```


In order to instrument a charm with tracing telemetry, you will need to:

1. Set up a model with `cos-lite`:


```bash
juju add-model clite
juju deploy cos-lite --trust
```
  
> See more: [Charmhub | `cos-lite`](https://charmhub.io/cos-lite)

2. Deploy `tempo`:

```bash
juju deploy tempo-k8s
```

> See more: [Charmhub | `tempo-k8s`](https://charmhub.io/tempo-k8s)

3. Integrate tempo with `cos-lite`:

```bash
jhack imatrix fill
```

> See more: {ref}``jhack` <jhack>`, [GitHub | `jhack` > `imatrix` > `fill`](https://github.com/PietroPasotti/jhack#fill)

Alternatively, you can integrate manually by:
```
juju integrate tempo:logging loki:logging
juju integrate tempo:ingress traefik:ingress
juju integrate grafana:grafana-source tempo:grafana-source
juju integrate prometheus:metrics-endpoint, tempo:metrics-endpoint
juju integrate grafana:grafana-dashboard, tempo:grafana-dashboard
juju integrate traefik:tracing, tempo:tracing
juju integrate prometheus:tracing, tempo:tracing
```

```{note}
 At some point there will be an overlay bundle to deploy `cos-lite` + `tempo` and integrate them; see [this PR](https://github.com/canonical/cos-lite-bundle/pull/79) to follow the progress on the overlay. 
```

At this point you should have a working `cos-lite` plus `tempo` deployment; something like this:
![image|690x333](upload://7ohHj2JBT9Zaezsgx6p3a56n5cO.png) 

4. Fetch the `charm_tracing` and the `tracing` libs:
```bash
charmcraft fetch-lib charms.tempo-k8s.v1.charm_tracing
charmcraft fetch-lib charms.tempo-k8s.v2.tracing
```

> See more: {ref}``charmcraft fetch-lib` <command-charmcraft-fetch-lib>`, [Charmhub | `tempo-k8s` > Libraries > `charm-tracing`](https://charmhub.io/tempo-k8s/libraries/charm_tracing), [Charmhub | `tempo-k8s` > Libraries > `tracing`](https://charmhub.io/tempo-k8s/libraries/tracing)

5. Add opentelemetry exporter dependency used by `charm_tracing` to your `requirements.txt`:

```
opentelemetry-exporter-otlp-proto-http>=1.21.0
```

6. Add an integration with `tempo`:

```yaml
# in charmcraft.yaml
provides:
  tracing:
    interface: tracing
    limit: 1
```

> See more: [File `charmcraft.yaml` > `provides`]()

7. Instrument your charm code:

```python
# in /your/charm/project/src/charm.py
from charms.tempo_k8s.v1.charm_tracing import trace_charm
from charms.tempo_k8s.v2.tracing import TracingEndpointRequirer

@trace_charm(tracing_endpoint="tracing_endpoint")
class MyCharm(CharmBase):
    def __init__(self, *args):
        super().__init__(*args)
        # Add a provider wrapper for the tracing endpoint.
        self.tracing = TracingEndpointRequirer(self, protocols=["otlp_http"])

    @property
    def tracing_endpoint(self) -> Optional[str]:
        """Tempo endpoint for charm tracing."""
        if self.tracing.is_ready():
            return self.tracing.get_endpoint("otlp_http")
        return None
```
```{note}
 
By default, the traces generated by this charm will be tagged with service name equal to the class name of the charm, so `"MyCharm"` in this case. You override this default by passing 
`service_name="foo"` to `trace_charm`. 

```


8. Pack, deploy, and integrate your charm with `cos-lite`:

```bash
charmcraft pack
juju deploy ./my-charm-operator_ubuntu-20.04-amd64.charm mycharm \
  $(yq eval '.resources | to_entries | map(select(.value.upstream-source != null) | "--resource " + .key + "=" + .value.upstream-source) | join(" ")' charmcraft.yaml)
juju integrate mycharm:tracing tempo-k8s:tracing
```

```{note}

`cos-lite` is a kubernetes bundle. `tempo` is a Kubernetes charm.
 
```

> See more: [`charmcraft pack` <command-charmcraft-pack>`, [Juju | `juju deploy`](https://juju.is/docs/juju/juju-deploy), [Juju | `juju integrate`](https://juju.is/docs/juju/juju-integrate)

9. View the traces for the charm. 

Open the Grafana dashboard in a browser ([see here](https://github.com/canonical/grafana-k8s-operator) for more detailed instructions).  

Next, navigate to the traces for your charm:
- go to `Explore` and select the Tempo datasource.
- pick the `service_name` you gave to MyCharm above (the default is the application name) to see the traces for that charm
![image|690x505](upload://rAZOurgeYtFfymdB1V0qzKg7HcW.png) 
- click on a trace ID to visualize it. For example, this is the trace for an `update-status` event on the Tempo charm itself:
![image|690x492](upload://6lufy3oZUYDkwxrnufQJKf5tpGN.png)


## Mapping events to traces with jhack tail
`jhack tail` supports a `-t` option to show the trace IDs associated with a charm execution:

![image|607x326](upload://1UUxRnTkBR3hkCPfWd0sd4AXqfJ.png)

This means that you can tail a charm, grab the trace id from tail, put it in the grafana dashboard query and get to the trace in no time.
